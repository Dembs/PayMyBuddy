<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Page Transfert</title>
</head>
<body>
<div class="nav-bar">
    <a th:href="@{/transfert}" class="active">Transférer</a>
    <a th:href="@{/profile}">Profil</a>
    <a th:href="@{/connections}">Ajouter Relation</a>
    <a th:href="@{/logout}">Se déconnecter</a>
</div>

<div class="container">

    <div class="balance-section">
        <h3>Solde du compte</h3>
        <p class="balance-amount" th:text="${#numbers.formatDecimal(balance, 1, 2) + ' €'}">0.00 €</p>
    </div>
    <div class="transfer-form">
        <h3>Effectuer une opération</h3>
        <form th:action="@{/transfert/add}" method="post" onsubmit="return confirmTransaction(event)">
            <div class="form-group">
                <label for="type">Type d'opération:</label>
                <select id="type" name="type" onchange="updateFormFields()">
                    <option value="TRANSFERT" selected>Transfert</option>
                    <option value="VIREMENT RENTRANT">Virement rentrant</option>
                    <option value="VIREMENT SORTANT">Virement sortant</option>
                </select>
            </div>

            <div id="connection-field" style="display:none">
                <label for="receiver">Destinataire:</label>
                <select id="receiver" name="receiverId" required>
                    <option value="">Sélectionnez une relation</option>
                    <th:block th:each="connection : ${user.connections}">
                        <option th:value="${connection.id}" th:text="${connection.getRealUsername()}"></option>
                    </th:block>
                </select>
            </div>

            <div id="description-field" class="form-group">
                <label for="description">Description:</label>
                <input type="text" id="description" name="description">
            </div>

            <div class="form-group">
                <label for="amount">Montant:</label>
                <input type="number"
                       id="amount"
                       name="amount"
                       step="0.01"
                       min="1.00"
                       value="0.00"
                       placeholder="0.00 €"
                       required
                       oninvalid="this.setCustomValidity('Le montant minimum est de 1€')"
                       oninput="this.setCustomValidity('')">
            </div>


            <button type="submit">Payer</button>
        </form>
    </div>
    <div class="transfert-list">
        <h3>Mes Transactions</h3>

        <div th:if="${#lists.isEmpty(transactions)}" class="no-connections">
            <p>Vous n'avez pas encore de transfert</p>
        </div>

        <table th:if="${!#lists.isEmpty(transactions)}" class="transfert-table">
            <thead>
            <tr>
                <th>Relations</th>
                <th>Description</th>
                <th>Date</th>
                <th>Montant</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="transaction : ${transactions}">

                <td th:text="${transaction.type.startsWith('VIREMENT') ?
                     'Ma banque' :
                      transaction.getReceiver().getRealUsername()}">
                </td>
                <td th:text="${transaction.description}"></td>
                <td th:text="${#dates.format(transaction.date,'dd/MM/yyyy HH:mm')}"></td>
                <td th:text="${#numbers.formatDecimal(transaction.amount, 1, 2,'POINT') + ' €'}"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

</body>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        updateFormFields();
    });
    function updateFormFields() {
        const type = document.getElementById('type').value;
        const connectionField = document.getElementById('connection-field');
        const descriptionField = document.getElementById('description-field');
        const receiverSelect = document.getElementById('receiver');

        if (type === 'TRANSFERT') {
            connectionField.style.display = 'block';
            descriptionField.style.display = 'block';
            receiverSelect.required = true;
        } else if (type.includes('VIREMENT')) {
            connectionField.style.display = 'none';
            descriptionField.style.display = 'none';
            receiverSelect.required = false;
            document.getElementById('description').value = type;
        }
    }
    function confirmTransaction(event) {
        const balance = [[${balance}]];
        event.preventDefault(); // Empêche l'envoi immédiat du formulaire

        const amount = parseFloat(document.getElementById('amount').value);
        const type = document.getElementById('type').value;
        const totalAmount = type === 'TRANSFERT' ? amount * 1.005 : amount;

        let message;

    // Vérification du solde pour les opérations sortantes
        if ((type === 'TRANSFERT' || type === 'VIREMENT SORTANT') && totalAmount > balance) {
            alert(`Solde insuffisant ! Votre solde actuel est de ${balance.toFixed(2)}€`);
            return false;
        }

        if (type === 'TRANSFERT') {
            const receiver = document.getElementById('receiver');
            if (!receiver.value) {
                alert('Veuillez sélectionner un destinataire');
                return false;
            }
            const receiverName = receiver.options[receiver.selectedIndex].text; // récupère le texte qui correspond à l'index choisit
            message = `Confirmez-vous le transfert de ${(amount/1.005).toFixed(2)}€ (0.5% de frais) vers ${receiverName} ?`;
        } else {
            message = `Confirmez-vous le ${type.toLowerCase()} de ${amount.toFixed(2)}€ ?`;
        }

        if (confirm(message)) {
            event.target.submit(); // Envoie le formulaire si confirmé
            return true;
        }
        return false;
    }
</script>
</html>